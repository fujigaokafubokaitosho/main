<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    /* 修正なし */
    :root { --primary: #2563eb; --error: #dc2626; --success: #10b981; --bg: #f8fafc; }
    body { font-family: sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
    .card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); width: 90%; max-width: 400px; }
    h2 { color: var(--primary); margin: 0 0 20px 0; text-align: center; }
    .step { display: none; }
    .step.active { display: block; }
    .input-group { margin-bottom: 16px; }
    label { display: block; font-size: 14px; margin-bottom: 4px; color: #64748b; }
    input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
    button { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    button:disabled { background: #94a3b8; cursor: not-allowed; }
    .msg { font-size: 14px; text-align: center; margin-top: 10px; min-height: 20px; }
    
    /* 成功時のアニメーション */
    @keyframes pop { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .success-icon { font-size: 64px; color: var(--success); animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
  </style>
</head>
<body>

<div id="mainBox" class="card">
  <h2>アカウント登録</h2>

  <div id="step1" class="step active">
    <div class="input-group">
      <label>配布されたID</label>
      <input type="text" id="regId" placeholder="例: 1001">
    </div>
    <div class="input-group">
      <label>お名前（ひらがな）</label>
      <input type="text" id="regName" placeholder="例: やまだ たろう">
    </div>
    <button id="nextBtn" onclick="checkIdentity()">次へ</button>
    <p id="err1" class="msg" style="color:var(--error)"></p>
  </div>

  <div id="step2" class="step">
    <div class="input-group">
      <label>メールアドレス</label>
      <input type="email" id="regEmail" placeholder="example@mail.com">
    </div>
    <div class="input-group">
      <label>パスワード (8文字以上32文字以内)</label>
      <input type="password" id="regPass1" oninput="validatePass()">
    </div>
    <div class="input-group">
      <label>パスワード (再入力)</label>
      <input type="password" id="regPass2" oninput="validatePass()">
    </div>
    <button id="submitBtn" onclick="submitRegister()" disabled>登録を完了する</button>
    <p id="err2" class="msg" style="color:var(--error)"></p>
  </div>
</div>

<script>
  // ★GASのウェブアプリURL (末尾に/exec)
  const GAS_URL = "YOUR_GAS_WEB_APP_URL";
  let verifiedId = "";

  // ★ fetch関数を使ってGASにデータを送信する共通関数
  async function callGasApi(action, params) {
    const url = `${GAS_URL}?action=${action}`;
    const response = await fetch(url, {
      method: 'POST',
      mode: 'no-cors', // 一旦no-corsで動かす場合
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams(params)
    });
    // no-corsの場合、response.json()は使えませんが、成功したとみなして進めます
    return { success: true }; 
  }

  // うまくいかない場合は、下記のようにCORSを有効にしたfetchを使います
  async function callGasApiWithCors(action, params) {
    const url = `${GAS_URL}?action=${action}`;
    const response = await fetch(url, {
      method: 'POST',
      // mode: 'cors', // ブラウザが自動的にcorsを選択する
      body: JSON.stringify(params) // JSON形式で送る場合
    });
    return await response.json();
  }

　const id = document.getElementById('regId').value.trim();
  const name = document.getElementById('regName').value.trim();
  
  // ★google.script.run を fetch に置き換え
  try {
    const response = await fetch(`${GAS_URL}?action=verifyInitialID`, {
      method: 'POST',
      mode: 'cors', // CORSを明示
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ id, name })
    });
    
    const res = await response.json(); // GASからのJSON応答を受け取る

    if(res.success) {
      verifiedId = id;
      document.getElementById('step1').classList.remove('active');
      document.getElementById('step2').classList.add('active');
    } else {
      document.getElementById('err1').innerText = res.message;
    }
  } catch (error) {
    console.error('Error:', error);
    document.getElementById('err1').innerText = "通信エラーが発生しました。";
  }

  function validatePass() {
    const p1 = document.getElementById('regPass1').value;
    const p2 = document.getElementById('regPass2').value;
    const btn = document.getElementById('submitBtn');
    btn.disabled = !(p1.length >= 8 && p1 === p2);
  }
  
  async function submitRegister() {
    const email = document.getElementById('regEmail').value.trim();
    const pass = document.getElementById('regPass1').value;
    const btn = document.getElementById('submitBtn');
    const err = document.getElementById('err2');
    
    btn.disabled = true;
    err.style.color = "var(--primary)";
    err.innerText = "登録情報を送信中...";

    try {
      const res = await callGasApi('registerUser', {id: verifiedId, email, pass});

      if(res.success) {
        const mainBox = document.getElementById('mainBox');
        mainBox.innerHTML = `
          <div style="text-align:center; padding:20px;">
            <i class="material-icons success-icon">check_circle</i>
            <h2 style="color:var(--success); margin-top:10px;">登録完了！</h2>
            <p style="color:#64748b;">ログイン画面へ移動します...</p>
          </div>
        `;

        setTimeout(() => {
          window.location.href = LOGIN_URL;
        }, 1500);
      } else {
        btn.disabled = false;
        err.style.color = "var(--error)";
        err.innerText = res.message;
      }
    } catch (e) {
      btn.disabled = false;
      err.style.color = "var(--error)";
      err.innerText = "通信エラーが発生しました。";
    }
  }
</script>
</body>
</html>

